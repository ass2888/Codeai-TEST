<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<link rel="manifest" href="/manifest.json" />
<title>Codeai</title>
<style>
/* قاعدة عامة لجميع العناصر */
*, *::before, *::after {
    box-sizing: border-box;
}

/* إزالة المربع الأزرق عند النقر على الموبايل */
* {
    -webkit-tap-highlight-color: transparent;
}

/* إزالة البرواز الذي يظهر عند التركيز (Focus) */
*:focus {
    outline: none !important;
}

:root {
  --bg-primary: #080808;      
  --bg-header: #141414;       
  --bg-secondary: #2A2A2A;    
  --text-color: #FFFFFF;      
  --accent-color: #333333;
  --border-color: rgba(255,255,255,0.1);
  --msg-ai-bg: transparent; 
}
[data-theme="light"] {
  --bg-primary: #FFFFFF;
  --bg-header: #F0F0F0;
  --bg-secondary: #E0E0E0;
  --text-color: #080808;
  --accent-color: #CCCCCC;
  --msg-ai-bg: transparent;
  --border-color: rgba(0,0,0,0.1);
}
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* يمنع أي سكرول للصفحة نفسها */
    position: fixed; /* تثبيت الصفحة في مكانها */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-primary);
    color: var(--text-color);
    transition: background 0.3s, color 0.3s;
    /* تحسينات للموبايل */
    -webkit-text-size-adjust: 100%;
    touch-action: none; /* يمنع حركات اللمس الافتراضية للجسم */
}
.topbar { height:70px; display:flex; align-items:center; justify-content:center; padding:8px 12px; background:var(--bg-header); border-bottom:1px solid var(--border-color); position:relative; z-index:100; }
.logo-container { display:flex; align-items:center; font-weight:bold; font-size:18px; opacity:0; transition: opacity 0.3s; }
.logo-symbol { font-family:'Courier New', Courier, monospace; font-size:28px; font-weight:900; margin-right:1px; margin-top:-4px; line-height:1; }/* تعديل الزر ليكون حاوية ثابتة */
.menu-btn { 
    position:fixed; top:12px; left:12px; width:44px; height:44px; 
    border-radius:10px; border:none; background:var(--bg-secondary); 
    color:var(--text-color); font-size:20px; cursor:pointer; z-index:3200; 
    display:flex; align-items:center; justify-content:center; 
    box-shadow:0 2px 5px rgba(0,0,0,0.2); 
    transition: background 0.3s; /* أزلنا تدوير الزر نفسه */
}
/* تنسيق الأيقونة الداخلية لتدور هي فقط */
.menu-btn span {
    display: block;
    transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
}
.menu-btn.active { background: var(--accent-color); }
.menu-btn.active span { transform: rotate(-180deg); } /* التدوير للأيقونة فقط */

/* دعم اللغة العربية (RTL) */[lang="ar"] .msg,
[lang="ar"] .input,
[lang="ar"] .codearea, 
[lang="ar"] .code-highlight {
    direction: rtl;
    text-align: right;
}

/*التأكد من أن الكود الإنجليزي داخل المحادثة يظهر من اليسار لليمين حتى في الوضع العربي */
[lang="ar"] .msg pre,
[lang="ar"] .msg code {
    direction: ltr;
    text-align: left;
}


.root {
    position: fixed;
    left: 0;
    top: 56px;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    z-index: 60;
    pointer-events: none;
    width: 100vw; /* عرض الشاشة فقط */
    max-width: 100%;
    overflow-x: hidden; /* تأكيد إضافي */
}


.input-bar { width:100%; padding:15px 16px 25px 16px; background: linear-gradient(to top, var(--bg-primary) 20%, rgba(0,0,0,0)); backdrop-filter: blur(5px); z-index:100; box-sizing:border-box; display:flex; justify-content:center; pointer-events:auto; }
.input-wrapper { position:relative; width:100%; max-width:800px; }
.input { width:100%; border-radius:30px; padding:16px 60px 16px 20px; border:1px solid var(--border-color); background:var(--bg-secondary); color:var(--text-color); font-size:16px; font-family:inherit; resize:none; overflow-y:hidden; line-height:24px; max-height:150px; box-sizing:border-box; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
.input:focus { outline:none; border-color:#666; }
.send-btn { position:absolute; right:6px; top:6px; width:46px; height:46px; border-radius:50%; border:none; background:var(--text-color); color:var(--bg-primary); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:transform 0.2s; z-index:101; }
.send-btn:active { transform:scale(0.95); }
#welcomeScreen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-primary); z-index:50; transition:opacity 0.3s; pointer-events:none; }
#welcomeScreen > * { pointer-events:auto; }
.welcome-logo { font-size:50px; font-weight:bold; display:flex; align-items:center; margin-bottom:10px; }
.welcome-logo span { font-family:'Courier New', monospace; font-size:70px; font-weight:900; margin-right:5px; }
.welcome-sub { font-size:16px; opacity:0.6; font-weight:normal; }
.hidden { opacity:0; pointer-events:none !important; }
.messages {
    flex: 1;
    overflow-y: auto; /* سكرول عمودي فقط */
    overflow-x: hidden; /* ممنوع السكرول الأفقي */
    padding: 20px 20px 0 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    pointer-events: auto;
    width: 100%;
}
.msg { max-width:90%; padding:12px 16px; border-radius:18px; word-wrap:break-word; line-height:1.6; font-size:15px; color:var(--text-color); }
.msg.user { margin-right:auto; margin-left:0; background:var(--bg-secondary); border-bottom-left-radius:4px; }
.msg.ai { margin-left:auto; margin-right:0; background:transparent; border:none; padding:0 5px; width:100%; max-width:100%; }
@keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }
.typing-cursor { display:inline-block; color:var(--text-color); font-weight:bold; margin-left:2px; animation:blink 1s infinite; }
.msg pre { background:#000; padding:12px; border-radius:8px; overflow-x:auto; margin:10px 0; border:1px solid #333; }
.msg code { font-family:'Consolas', monospace; font-size:13px; color:#e0e0e0; }
.code-snippet-card { background:rgba(255,255,255,0.05); border:1px solid var(--accent-color); border-radius:8px; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; margin:10px 0; cursor:pointer; transition:background 0.2s; }
.code-snippet-card:hover { background:rgba(255,255,255,0.1); }
#menuPanel { position:fixed; left:-320px; top:0; width:300px; height:100%; background:var(--bg-header); padding:80px 12px 40px 12px; box-shadow:2px 0 20px rgba(0,0,0,0.5); transition:transform .3s cubic-bezier(0.25,1,0.5,1); z-index:3000; border-right:1px solid var(--border-color); display:flex; flex-direction:column; box-sizing:border-box; }
#menuPanel.open { transform:translateX(320px); }
#convList { flex:1; overflow-y:auto; margin-bottom:10px; }
#newChatBtn { background:var(--bg-secondary); border:none; color:var(--text-color); font-weight:bold; padding:12px; cursor:pointer; margin-bottom:20px; width:100%; border-radius:8px; }
#openSettings { margin-top:auto; padding:14px; border-radius:8px; background:var(--bg-secondary); color:var(--text-color); border:none; width:100%; }
#codezone {
    /* يجب أن يكون ارتفاعها 100% من الحاوية الأم */
    height: 100%;
    
    /* استخدام Flexbox لتوزيع الارتفاع */
    display: flex;
    flex-direction: column;
    
    /* إخفاء شريط التمرير الكلي للصفحة */
    overflow: hidden; 
}
#codeArea {
    /* هذا هو العنصر الذي سيظهر شريط التمرير فعلياً */
    overflow: auto; 
    /* ... (باقي خصائص #codeArea مثل opacity و resize) ... */
}
#codeArea, .highlighting-container {
    /* وضع مطلق لتتراكب فوق بعضها البعض تماماً */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%; /* مهم جداً لتأخذ ارتفاع الحاوية بالكامل */
}
.codezone { position:fixed; left:100%; top:0; width:100%; height:100%; background:var(--bg-primary); transition:transform .32s ease; z-index:3500; display:flex; flex-direction:column; }
.code-editor-container {
    /* تأخذ الارتفاع المتبقي بعد شريط التبويبات */
    flex-grow: 1; 
    
    /* يجب أن تكون الحاوية نسبية للتموضع المطلق للعناصر الداخلية */
    position: relative; 
    
    /* منع أي تمرير غير مرغوب فيه في الحاوية */
    overflow: hidden;
}
.codezone.open { transform:translateX(-100%); }/* --- 1. تعديل السكرول الأفقي للكود --- */
.codearea, .code-highlight {
    /* تغيير من pre-wrap إلى pre للسماح بالسكرول الأفقي */
    white-space: pre !important; 
    overflow-x: auto !important;
    overflow-y: auto !important;
}
.highlighting-container {
    /* يجب أن يكون مخفياً للتمرير ليتم مزامنته مع #codeArea */
    overflow: hidden;
}

/* --- 2. ستايل المودال الجديد (تعديل التبويبات) --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
    z-index: 5000; display: none; align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal-box {
    background: var(--bg-header); border: 1px solid var(--border-color);
    border-radius: 16px; padding: 20px; width: 85%; max-width: 320px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 15px;
}
.modal-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
.modal-input {
    background: var(--bg-primary); border: 1px solid var(--border-color);
    color: var(--text-color); padding: 12px; border-radius: 8px; font-size: 14px; outline: none;
}
.modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 5px; }
.btn-save {
    background: var(--text-color); color: var(--bg-primary); border: none;
    padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;
}
.btn-delete {
    background: rgba(255, 50, 50, 0.1); color: #ff4444; border: 1px solid rgba(255, 50, 50, 0.3);
    padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;
}

/* --- 3. إصلاح مؤشر الكتابة ليظهر في نفس السطر --- */
/* سنستخدم CSS Pseudo-element بدلاً من span لضمان ظهوره بشكل صحيح */
.msg.ai.typing-active > *:last-child::after {
    content: " <"; /* العلامة المطلوبة */
    display: inline-block;
    font-weight: bold;
    animation: blink 1s infinite;
    margin-left: 2px;
}
/* إخفاء المؤشر القديم إن وجد */
.typing-cursor { display: none !important; }

.settings-page { position:fixed; left:0; top:0; right:0; bottom:0; background:var(--bg-primary); padding:20px; display:none; flex-direction:column; z-index:4000; }
.settings-page.open { display:flex; }
.setting-row-btn { width:100%; padding:18px; margin-bottom:10px; background:var(--bg-secondary); border-radius:12px; color:var(--text-color); border:none; text-align:left; cursor:pointer; }
.popover-options { position:absolute; top:70px; left:20px; background:var(--bg-header); border:1px solid var(--border-color); padding:8px; border-radius:12px; display:none; flex-direction:column; z-index:4010; min-width:160px; }
.popover-options.show { display:flex; }
.option-item { padding:10px; cursor:pointer; }
.fullscreen-overlay { background:#fff; z-index:5000; display:none; flex-direction:column; position:fixed; top:0; left:0; right:0; bottom:0; width:100%; height:100%; }
.fullscreen-overlay.active { display:flex; }
.preview-header { height:56px; background:#f0f0f0; display:flex; align-items:center; justify-content:space-between; padding:0 16px; color:#000; border-bottom:1px solid #ccc; }
.run-fab { position:absolute; bottom:24px; right:24px; width:60px; height:60px; border-radius:16px; background:var(--bg-secondary); border:1px solid var(--border-color); box-shadow:0 6px 20px rgba(0,0,0,0.6); cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10; }
.play-icon { width:0; height:0; border-left:18px solid var(--text-color); border-top:10px solid transparent; border-bottom:10px solid transparent; margin-left:4px; }
/* New class for settings/close buttons */
.settings-btn { background:var(--bg-secondary); border:1px solid var(--border-color); color:var(--text-color); border-radius:20px; font-weight:bold; cursor:pointer; }
/* حاوية محرر الكود */
.editor-container {
    position: relative;
    flex: 1;
    width: 100%;
    height: 100%;
    background: #050505;
    overflow: hidden;
}
/* التنسيق المشترك للمحرر وطبقة التلوين ليظهروا متطابقين تماماً */
.codearea, .code-highlight {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 15px;
    margin: 0;
    border: none;
    font-family: 'Consolas', 'Monaco', monospace; /* نوع خط موحد */
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    box-sizing: border-box;
    text-align: left; /* الكود دائما يسار لليمين */
    direction: ltr;
}
/* منطقة الكتابة الفعلية (شفافة) */
.codearea {
    z-index: 2;
    background: transparent;
    color: transparent; /* النص شفاف لنرى الألوان تحته */
    caret-color: #fff; /* لون مؤشر الكتابة */
    resize: none;
}
.codearea:focus { outline: none; }

/* طبقة الألوان (في الخلفية) */
.code-highlight {
    z-index: 1;
    pointer-events: none; /* لا تتفاعل مع الماوس */
    background: #050505;
    color: #e6eef8;
    overflow: hidden; 
}
/* تنسيق القيم في الإعدادات */
.setting-value {
    float: right;
    font-weight: 900; /* سميك جداً */
    opacity: 0.9;
}
html[dir="rtl"] .setting-value { float: left; }

/* تعديل زر الإرسال الجديد */
.send-icon-new {
    width: 24px;
    height: 24px;
    fill: var(--bg-primary);
    transform: rotate(-90deg); /* تدوير أيقونة السهم لليسار لتشير للأعلى */
    font-weight: bold;
}
/* 1. إجبار الكود على أن يكون دائماً LTR (يسار لليمين) */
.codearea, .code-highlight, .msg pre, .msg code {
    direction: ltr !important;
    text-align: left !important;
}

/* 2. تحسين شريط أدوات الكود العلوي */
.code-header-wrapper {
    background: var(--bg-header);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
}

.code-toolbar {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 10px;
}

.toolbar-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* تصميم الأزرار المربعة (C, M, X) */
.tool-btn {
    width: 34px;
    height: 34px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    font-weight: bold;
    font-family: 'Segoe UI', sans-serif;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}
.tool-btn:active { transform: scale(0.95); background: var(--accent-color); }

/* 3. نظام التبويبات (Tabs) */
.tabs-bar {
    display: flex;
    align-items: center;
    background: #000; /* لون داكن خلف التبويبات */
    overflow-x: auto;
    height: 38px;
    padding-left: 5px;
}
.tabs-bar::-webkit-scrollbar { height: 0; width: 0; } /* إخفاء السكرول */

.tab {
    background: #1a1a1a;
    color: #888;
    padding: 8px 15px;
    font-size: 13px;
    border-right: 1px solid #333;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    display: flex;
    align-items: center;
    height: 100%;
    border-top: 2px solid transparent;
}
.tab.active {
    background: #050505; /* نفس لون الخلفية للمحرر */
    color: #fff;
    border-top: 2px solid var(--text-color);
}
.tab-add-btn {
    color: #fff;
    background: transparent;
    border: none;
    font-size: 20px;
    padding: 0 12px;
    cursor: pointer;
    height: 100%;
    display: flex;
    align-items: center;
}
.tab-add-btn:hover { background: rgba(255,255,255,0.1); }
/* --- تأثير بصري لظهور القائمة (Animation) --- */
@keyframes modalPop {
    0% { 
        opacity: 0; 
        transform: scale(0.9) translateY(10px); 
    }
    100% { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    }
}

.modal-overlay {
    /* إضافة انتقال للشفافية */
    transition: opacity 0.3s ease;
}

.modal-overlay.active .modal-box {
    /* تطبيق الأنيميشن عند تفعيل الكلاس active */
    animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

/* تحسين مظهر زر الحذف */
.btn-delete {
    background: rgba(255, 50, 50, 0.1); 
    color: #ff4444; 
    border: 1px solid rgba(255, 50, 50, 0.3);
    padding: 12px; 
    border-radius: 8px; 
    font-weight: bold; 
    cursor: pointer;
    transition: background 0.2s;
}
.btn-delete:hover {
    background: rgba(255, 50, 50, 0.2);
}

/* --- 1. أنيميشن إغلاق المودال (عكس الفتح) --- */
@keyframes modalPopOut {
    0% { opacity: 1; transform: scale(1) translateY(0); }
    100% { opacity: 0; transform: scale(0.9) translateY(10px); }
}

/* كلاس سيتم إضافته بالجافاسكربت عند الإغلاق */
.modal-overlay.closing .modal-box {
    animation: modalPopOut 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
.modal-overlay.closing {
    opacity: 0; /* إخفاء الخلفية تدريجياً */
    pointer-events: none;
}

/* --- 2. تصميم أزرار التحكم (Copy, Retry, Edit) --- */
.msg-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    justify-content: flex-start; /* الزاوية اليسرى */
    opacity: 0.8;
}
.action-btn {
    width: 28px;
    height: 28px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.action-btn:hover {
    background: var(--text-color);
    color: var(--bg-primary);
    transform: scale(1.05);
}

</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
</head>
<body>
<button id="menuBtn" class="menu-btn" aria-label="menu"><span>☰</span></button>
  <div id="welcomeScreen">
      <div class="welcome-logo">
          <span>&lt;</span>odeai
      </div>
      <div class="welcome-sub">What can I help you with?</div>
  </div>
  <div class="topbar">
    <div id="topLogo" class="logo-container">
        <span class="logo-symbol">&lt;</span>
        <span class="logo-text-part">odeai</span>
    </div>
  </div>
  <div id="menuPanel">
    <button id="newChatBtn">New chat +</button>
    <h3 style="margin:10px 0 5px 0; color:var(--text-color); opacity:0.6; font-size:12px; text-transform:uppercase">Conversations</h3>
    <div id="convList"></div>
    <button id="openSettings">Settings</button>
  </div>

  <div class="root">
    <div id="messages" class="messages" aria-live="polite"></div>
    <div class="input-bar">
      <div class="input-wrapper">
         <textarea id="input" class="input" placeholder="Type a message..." rows="1"></textarea>
        <button id="sendBtn" class="send-btn" title="Send">
    <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
</button>
      </div>
    </div>
  </div><div id="codezone" class="codezone" aria-hidden="true">
    <input type="file" id="importFileInput" style="display: none;" accept=".html,.js,.css,.txt,.json">

    <div class="code-header-wrapper">
        <div class="code-toolbar">
            <div style="font-weight:bold; font-size:16px;">Project Code</div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="btnImport" title="Import (M)">M</button>
                <button class="tool-btn" id="btnExport" title="Export (X)">X</button>
                <button class="tool-btn" id="btnCopy" title="Copy (C)">C</button>
                
                <button id="closeCodeBtn" class="settings-btn" style="font-size:13px; width:auto; padding:6px 12px; margin-left:5px;">Back</button>
            </div>
        </div>

        <div class="tabs-bar" id="tabsContainer">
            <button id="addTabBtn" class="tab-add-btn">+</button>
        </div>
    </div>
    
    <div class="editor-container">
        <pre class="code-highlight" aria-hidden="true"><code id="highlighting-content" class="language-javascript"></code></pre>
        <textarea id="codeArea" class="codearea" spellcheck="false">// Your project code will appear here...</textarea>
    </div>

    <button id="runFab" class="run-fab" title="Run Code">
      <div class="play-icon"></div>
    </button>
</div>



  <div id="previewOverlay" class="fullscreen-overlay">
    <div class="preview-header">
      <span>Live Preview</span>
      <button id="closePreviewMain" class="settings-btn" style="background:#ddd; color:#000; font-size:14px;width:auto;padding:6px 15px;">Close</button>
    </div>
    <iframe id="previewFrame" style="flex:1;border:none;background:#fff"></iframe>
  </div>
<div id="settingsPage" class="settings-page" aria-hidden="true">
    <h2 style="margin-bottom:30px; margin-top:40px">Settings</h2>
    
    <div style="position:relative;">
        <button id="themeBtn" class="setting-row-btn">
            Theme <span id="themeValue" class="setting-value">Dark</span>
        </button>
        <div id="themePopover" class="popover-options">
            <div class="option-item" onclick="setTheme('dark')">Dark</div>
            <div class="option-item" onclick="setTheme('light')">Light</div>
        </div>
    </div>

    <div style="position:relative;">
        <button id="langBtn" class="setting-row-btn">
            Language <span id="langValue" class="setting-value">English</span>
        </button>
        <div id="langPopover" class="popover-options">
            <div class="option-item" onclick="setLanguage('en')">English</div>
            <div class="option-item" onclick="setLanguage('ar')">العربية</div>
        </div>
    </div>

    <div style="margin-top:auto; display:flex; justify-content:center; margin-bottom: 20px;">
      <button id="closeSettings" style="padding:14px 40px; border-radius:30px; background:transparent; border:1px solid var(--border-color); color:var(--text-color); cursor:pointer">Close</button>
    </div>
  </div>
  <div id="tabModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">Edit Tab</div>
        <input type="text" id="tabNameInput" class="modal-input" placeholder="File name...">
        <div class="modal-actions">
            <button id="modalSaveBtn" class="btn-save">Save</button>
            <button id="modalDeleteBtn" class="btn-delete">Delete File</button>
            <button id="modalCancelBtn" class="settings-btn" style="background:transparent; border:none;">Cancel</button>
        </div>
    </div>
</div>
  <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Constants & Setup ---
    const RENDER_SERVER_URL = ''; 
    let convs = [];
    try {
        convs = JSON.parse(localStorage.getItem('codeai_convs') || '[]');
    } catch(e) { console.error("Storage corrupted", e); convs=[]; }
    
    let activeId = null;
    let isStreaming = false;
    let safeBuffer = "";
    let typeQueue = []; 
    let typeInterval = null; 
    let currentAiMsgElement = null; 
    let fullMarkdownBuffer = ""; 
    let streamCursor = 0;

    // إدارة الملفات
    let projectFiles = [{ name: 'index.html', content: '// Start coding...' }];
    let activeFileIndex = 0;
    let longPressTimer;

    // --- Elements ---
    const messagesEl = document.getElementById('messages');
    const codeArea = document.getElementById('codeArea');
    const highlightingContent = document.getElementById('highlighting-content');
    const inputEl = document.getElementById('input');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const topLogo = document.getElementById('topLogo');
    const menuBtn = document.getElementById('menuBtn');
    const menuPanel = document.getElementById('menuPanel');
    const codezone = document.getElementById('codezone');
    const settingsPage = document.getElementById('settingsPage');

    // --- Settings Logic ---
    function updateSettingsUI() {
        const t = localStorage.getItem('codeai_theme') || 'dark';
        const l = localStorage.getItem('codeai_lang') || 'en';
        
        document.getElementById('themeValue').textContent = t.charAt(0).toUpperCase() + t.slice(1);
        document.getElementById('langValue').textContent = l === 'en' ? 'English' : 'العربية';
        
        document.documentElement.setAttribute('data-theme', t);
        document.documentElement.setAttribute('lang', l);
    }

    updateSettingsUI();

    window.setTheme = function(mode) {
        localStorage.setItem('codeai_theme', mode);
        document.getElementById('themePopover').classList.remove('show');
        updateSettingsUI();
    };

    window.setLanguage = function(lang) {
        localStorage.setItem('codeai_lang', lang);
        document.getElementById('langPopover').classList.remove('show');
        updateSettingsUI();
        renderMessages();
    };

    // --- Code Highlighting Logic ---
    function updateCodeHighlight() {
        let text = codeArea.value || '';
        if(text.length > 0 && text[text.length-1] === "\n") { 
            text += " "; 
        }
        highlightingContent.textContent = text;
        if(window.Prism) {
            Prism.highlightElement(highlightingContent);
        }
    }

    codeArea.addEventListener('input', function() {
        updateCodeHighlight();
        projectFiles[activeFileIndex].content = this.value;
        const conv = convs.find(c => c.id === activeId);
        if(conv) {
            conv.files = projectFiles;
            conv.code = projectFiles[0].content;
            saveState();
        }
    });

    codeArea.addEventListener('scroll', function() {
        highlightingContent.parentElement.scrollTop = this.scrollTop;
        highlightingContent.parentElement.scrollLeft = this.scrollLeft;
    });
    
    updateCodeHighlight();

    if (typeof marked !== 'undefined') {
        marked.setOptions({ gfm: true, breaks: true });
    }

    // --- Event Listeners (UI) ---
    menuBtn.addEventListener('click', () => {
        menuPanel.classList.toggle('open');
        menuBtn.classList.toggle('active');
    });

    document.getElementById('newChatBtn').addEventListener('click', () => {
        activeId = null;
        codeArea.value = '// start';
        updateCodeHighlight();
        renderMessages();
        menuPanel.classList.remove('open');
        menuBtn.classList.remove('active');
    });

    document.getElementById('openSettings').addEventListener('click', () => {
        settingsPage.classList.add('open');
        menuPanel.classList.remove('open');
        menuBtn.classList.remove('active');
    });

    document.getElementById('closeSettings').addEventListener('click', () => {
        settingsPage.classList.remove('open');
    });

    document.getElementById('themeBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('themePopover').classList.toggle('show');
        document.getElementById('langPopover').classList.remove('show');
    });
    
    document.getElementById('langBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('langPopover').classList.toggle('show');
        document.getElementById('themePopover').classList.remove('show');
    });

    document.addEventListener('click', () => {
        document.getElementById('themePopover').classList.remove('show');
        document.getElementById('langPopover').classList.remove('show');
    });

    // Swipe Codezone
    let startX = 0;
    document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});
    document.addEventListener('touchend', e => {
        const endX = (e.changedTouches[0] && e.changedTouches[0].clientX) || startX;
        if (endX - startX < -80) { 
            codezone.classList.add('open'); 
            updateCodeHighlight();
        }
        if (endX - startX > 80) codezone.classList.remove('open');
    }, {passive: true});

    document.getElementById('closeCodeBtn').addEventListener('click', () => {
        codezone.classList.remove('open');
    });
    
    // Preview
    const runFab = document.getElementById('runFab');
    const previewOverlay = document.getElementById('previewOverlay');
    runFab.addEventListener('click', () => {
        previewOverlay.classList.add('active');
        document.getElementById('previewFrame').srcdoc = codeArea.value;
    });
    document.getElementById('closePreviewMain').addEventListener('click', () => {
        previewOverlay.classList.remove('active');
    });

    // Input Logic
    inputEl.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        this.style.overflowY = this.scrollHeight > 150 ? 'auto' : 'hidden';
    });
    inputEl.addEventListener('keydown', e => { 
        if(e.key==='Enter' && !e.shiftKey){ 
            e.preventDefault(); 
            document.getElementById('sendBtn').click(); 
        }
    });

    document.getElementById('sendBtn').addEventListener('click', ()=> {
        const v = inputEl.value.trim();
        if(!v) return;
        inputEl.value=''; 
        inputEl.style.height = 'auto';
        sendMessage(v);
    });

    // --- Tab & File Management System ---
    const tabModal = document.getElementById('tabModal');
    const tabNameInput = document.getElementById('tabNameInput');
    let editingTabIndex = -1;

    function openTabModal(index) {
        editingTabIndex = index;
        tabNameInput.value = projectFiles[index].name;
        
        const delBtn = document.getElementById('modalDeleteBtn');
        if (projectFiles.length <= 1) delBtn.style.display = 'none';
        else delBtn.style.display = 'block';

        tabModal.classList.add('active');
    }

    function closeTabModal() {
        tabModal.classList.add('closing');
        setTimeout(() => {
            tabModal.classList.remove('active');
            tabModal.classList.remove('closing');
            editingTabIndex = -1;
        }, 300);
    }

    document.getElementById('modalCancelBtn').addEventListener('click', closeTabModal);

    document.getElementById('modalSaveBtn').addEventListener('click', () => {
        if (editingTabIndex > -1) {
            const newName = tabNameInput.value.trim();
            if (newName) {
                projectFiles[editingTabIndex].name = newName;
                renderTabs();
            }
        }
        closeTabModal();
    });

    document.getElementById('modalDeleteBtn').addEventListener('click', () => {
        if (editingTabIndex > -1 && projectFiles.length > 1) {
            if (confirm('Delete this file?')) {
                projectFiles.splice(editingTabIndex, 1);
                if (activeFileIndex >= projectFiles.length) {
                    activeFileIndex = projectFiles.length - 1;
                }
                codeArea.value = projectFiles[activeFileIndex].content;
                updateCodeHighlight();
                renderTabs();
            }
        }
        closeTabModal();
    });

    function renderTabs() {
        const container = document.getElementById('tabsContainer');
        const addBtn = document.getElementById('addTabBtn');
        
        Array.from(container.children).forEach(child => {
            if (child.id !== 'addTabBtn') container.removeChild(child);
        });

        projectFiles.forEach((file, index) => {
            const tab = document.createElement('div');
            tab.className = `tab ${index === activeFileIndex ? 'active' : ''}`;
            tab.textContent = file.name;
            
            tab.addEventListener('click', () => switchTab(index));

            tab.addEventListener('touchstart', () => {
                longPressTimer = setTimeout(() => openTabModal(index), 800);
            });
            tab.addEventListener('touchend', () => clearTimeout(longPressTimer));
            tab.addEventListener('contextmenu', (e) => { 
                e.preventDefault();
                openTabModal(index);
            });

            container.insertBefore(tab, addBtn);
        });
    }

    function switchTab(index) {
        projectFiles[activeFileIndex].content = codeArea.value;
        activeFileIndex = index;
        codeArea.value = projectFiles[index].content;
        updateCodeHighlight();
        renderTabs();
    }

    function addNewTab() {
        projectFiles[activeFileIndex].content = codeArea.value;
        const newName = "Untitled" + (projectFiles.length > 0 ? projectFiles.length : "") + ".html";
        projectFiles.push({ name: newName, content: "" });
        activeFileIndex = projectFiles.length - 1;
        codeArea.value = "";
        updateCodeHighlight();
        renderTabs();
    }

    // --- Button Actions ---
    document.getElementById('btnExport').addEventListener('click', () => {
        const currentFile = projectFiles[activeFileIndex];
        currentFile.content = codeArea.value;
        
        const blob = new Blob([currentFile.content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = currentFile.name;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    });

    document.getElementById('btnCopy').addEventListener('click', () => {
        navigator.clipboard.writeText(codeArea.value).then(() => {
            const btn = document.getElementById('btnCopy');
            const originalText = btn.textContent;
            btn.textContent = "✔";
            setTimeout(() => btn.textContent = originalText, 1500);
        });
    });

    const fileInput = document.getElementById('importFileInput');
    document.getElementById('btnImport').addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            codeArea.value = content;
            projectFiles[activeFileIndex].content = content;
            projectFiles[activeFileIndex].name = file.name;
            updateCodeHighlight();
            renderTabs();
        };
        reader.readAsText(file);
        fileInput.value = '';
    });

    document.getElementById('addTabBtn').addEventListener('click', addNewTab);
    
    // --- Core Functions ---
    function renderMessages(){
        messagesEl.innerHTML = '';
        if(!activeId) {
            welcomeScreen.classList.remove('hidden');
            topLogo.style.opacity = '0';
            return;
        }

        const conv = convs.find(c=>c.id===activeId);
        if(!conv || conv.messages.length === 0) {
            welcomeScreen.classList.remove('hidden');
            topLogo.style.opacity = '0';
        } else {
            welcomeScreen.classList.add('hidden');
            topLogo.style.opacity = '1';
        }

        if(conv) {
            conv.messages.forEach((m, index) => {
                const d = document.createElement('div');
                d.className = 'msg ' + (m.role==='user'?'user':'ai');
                let htmlContent = typeof marked !== 'undefined' ? marked.parse(m.text || '') : m.text;
                
                if (m.role === 'ai' && isStreaming && index === conv.messages.length - 1) {
                    d.innerHTML = htmlContent + '<span class="typing-cursor">|</span>';
                } else {
                    d.innerHTML = htmlContent;
                }
                messagesEl.appendChild(d);
            });
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function saveState(){ localStorage.setItem('codeai_convs', JSON.stringify(convs)); }
    
    async function sendMessage(text){
        if(!text) return;
        welcomeScreen.classList.add('hidden');
        topLogo.style.opacity = '1';

        if (!activeId) {
            const newId = Date.now().toString();
            const title = text.length > 30 ? text.substring(0, 30) + '...' : text;
            projectFiles = [{ name: 'index.html', content: '// Start coding...' }];
            activeFileIndex = 0;
            renderTabs();

            convs.unshift({ 
                id: newId, 
                title: title, 
                messages: [], 
                files: projectFiles, 
                code: '// Start coding...' 
            });
            activeId = newId;
            renderConversations();
        }

        const conv = convs.find(c=>c.id===activeId);
        conv.messages.push({role:'user', text});
        saveState();
        renderMessages();

        isStreaming = true;
        safeBuffer = ""; 
        fullMarkdownBuffer = ""; 
        typeQueue = []; 
        streamCursor = 0;
        currentAiMsgElement = null;

        conv.messages.push({role:'ai', text:''}); 
        saveState();
        renderMessages();

        try {
            await fetch(RENDER_SERVER_URL + '/api/chat', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    message: text, 
                    convId: activeId, 
                    files: projectFiles 
                })
            });
        } catch(err){
            const last = conv.messages[conv.messages.length-1];
            last.text = 'Error: Could not reach server.';
            isStreaming = false;
            saveState(); 
            renderMessages();
        }
    }
    
    function renderConversations(){
        const c = document.getElementById('convList');
        c.innerHTML = '';
        convs.forEach(cv=>{
            const el = document.createElement('div'); 
            el.style.padding='14px'; 
            el.style.borderBottom='1px solid var(--border-color)';
            el.style.cursor='pointer'; 
            el.style.color = 'var(--text-color)';
            el.textContent=cv.title;
            
            el.addEventListener('click', ()=> { 
                activeId = cv.id; 
                if (cv.files && Array.isArray(cv.files)) {
                    projectFiles = cv.files;
                } else {
                    projectFiles = [{ name: 'index.html', content: cv.code || '' }];
                }
                activeFileIndex = 0;
                codeArea.value = projectFiles[0].content;
                renderTabs();
                updateCodeHighlight(); 
                renderMessages(); 
                menuPanel.classList.remove('open'); 
                menuBtn.classList.remove('active');
            });
            
            c.appendChild(el);
        });
    }

    function startTyping() {
        typeInterval = setInterval(() => {
            if (typeQueue.length > 0) {
                const char = typeQueue.shift();
                fullMarkdownBuffer += char; 
                
                if (currentAiMsgElement) {
                    currentAiMsgElement.classList.add('typing-active');
                    let html = marked.parse(fullMarkdownBuffer);
                    currentAiMsgElement.innerHTML = html;
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
                
                const conv = convs.find(c => c.id === activeId);
                if(conv) {
                    const lastMsg = conv.messages[conv.messages.length - 1];
                    lastMsg.text = fullMarkdownBuffer;
                }
            } else {
                clearInterval(typeInterval);
                typeInterval = null;
            }
        }, 30); 
    }
    
    // --- Helper for Message Actions ---
    function addMessageActions(msgElement, fullText) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'msg-actions';

        const btnCopy = document.createElement('button');
        btnCopy.className = 'action-btn';
        btnCopy.textContent = 'C';
        btnCopy.title = 'Copy Response';
        btnCopy.onclick = () => {
            navigator.clipboard.writeText(fullText).then(() => {
                const original = btnCopy.textContent;
                btnCopy.textContent = '✔';
                setTimeout(() => btnCopy.textContent = original, 1500);
            });
        };

        const btnRetry = document.createElement('button');
        btnRetry.className = 'action-btn';
        btnRetry.textContent = 'R';
        btnRetry.title = 'Retry';
        btnRetry.onclick = () => handleRetryOrEdit('retry');

        const btnEdit = document.createElement('button');
        btnEdit.className = 'action-btn';
        btnEdit.textContent = 'E';
        btnEdit.title = 'Edit & Resend';
        btnEdit.onclick = () => handleRetryOrEdit('edit');

        actionsDiv.appendChild(btnCopy);
        actionsDiv.appendChild(btnRetry);
        actionsDiv.appendChild(btnEdit);
        
        msgElement.appendChild(actionsDiv);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function handleRetryOrEdit(mode) {
        const conv = convs.find(c => c.id === activeId);
        if (!conv || conv.messages.length < 2) return;

        const userMsgIndex = conv.messages.length - 2;
        const lastUserText = conv.messages[userMsgIndex].text;

        conv.messages.splice(userMsgIndex, 2);
        saveState();
        renderMessages();

        if (mode === 'edit') {
            inputEl.value = lastUserText;
            inputEl.focus();
            inputEl.style.height = 'auto';
            inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
        } else {
            sendMessage(lastUserText);
        }
    }function processFilesUpdate(fullText) {
        let filesUpdated = false;

        // 1. معالجة الملفات المكتملة (التي لها وسم بداية ونهاية)
        const completeFileRegex = /<FILE name="([^"]+)">([\s\S]*?)<\/FILE>/g;
        let match;
        while ((match = completeFileRegex.exec(fullText)) !== null) {
            const fileName = match[1].trim();
            let fileContent = match[2].trim();
            fileContent = fileContent.replace(/^```[a-z]*\n?/i, '').replace(/```$/i, '');
            updateFileContent(fileName, fileContent);
            filesUpdated = true;
        }

        // 2. معالجة الملف "الجاري كتابته" (الذي له وسم بداية فقط في آخر النص)
        // هذا الجزء يحل مشكلة "عدم رؤية الكود" أثناء التوليد
        const partialFileRegex = /<FILE name="([^"]+)">([\s\S]*)$/;
        const partialMatch = partialFileRegex.exec(fullText);
        
        if (partialMatch) {
            const fileName = partialMatch[1].trim();
            let fileContent = partialMatch[2]; // لا نقوم بـ trim هنا للحفاظ على مسافات الكتابة
            
            // تنظيف بدايات الكود فقط
            fileContent = fileContent.replace(/^```[a-z]*\n?/i, '');
            
            // نتأكد أننا لا نأخذ ملفاً تم إغلاقه بالفعل في الخطوة 1
            // (الريجكس الجزئي قد يلتقط آخر ملف مغلق إذا لم نكن حذرين، 
            // لكن بما أن الريجكس الأول التهم العلامات المغلقة، فالخطر هنا هو التداخل)
            // الحل الأبسط: إذا وجدنا وسم إغلاق داخل المحتوى الجزئي، نتجاهله لأن الخطوة 1 عالجته
            if (!fileContent.includes('</FILE>')) {
                updateFileContent(fileName, fileContent);
                filesUpdated = true;
            }
        }

        if (filesUpdated) {
            renderTabs();
            // حفظ الحالة فقط (بدون إعادة الرسم الثقيل)
            const conv = convs.find(c => c.id === activeId);
            if(conv) {
                conv.files = projectFiles;
                conv.code = projectFiles[0].content;
                // saveState(); // يمكن تأجيل الحفظ للنهاية لتحسين الأداء
            }
        }
    }

    // دالة مساعدة لتحديث أو إنشاء ملف
    function updateFileContent(fileName, content) {
        const existingIndex = projectFiles.findIndex(f => f.name === fileName);
        if (existingIndex !== -1) {
            projectFiles[existingIndex].content = content;
            // تحديث المحرر فقط إذا كان هذا هو الملف المفتوح
            if (existingIndex === activeFileIndex) {
                // نحفظ مكان المؤشر والسكرول قبل التحديث لمنع القفز
                const scrollTop = codeArea.scrollTop;
                const selectionStart = codeArea.selectionStart;
                
                codeArea.value = content;
                updateCodeHighlight();
                
                // إعادة السكرول والمؤشر (اختياري، لكن يحسن التجربة)
                codeArea.scrollTop = scrollTop;
                // codeArea.setSelectionRange(selectionStart, selectionStart);
            }
        } else {
            projectFiles.push({ name: fileName, content: content });
            // إذا كان ملفاً جديداً، نفتح تبويب له ونعرضه فوراً
            if (projectFiles.length === 1) { // أول ملف
                 activeFileIndex = 0;
                 codeArea.value = content;
                 updateCodeHighlight();
            }
        }
    }

    

    // --- SSE Handling ---
    if(typeof(EventSource) !== 'undefined'){
        const sse = new EventSource(RENDER_SERVER_URL + '/api/events');
        
        sse.onmessage = (e) => {
            try {
                if (e.data === ': keep-alive\n\n') return;
                const payload = JSON.parse(e.data);
                if(payload.type !== 'assistant_message') return;

                if (!currentAiMsgElement && isStreaming) {
                    const conv = convs.find(c => c.id === activeId);
                    if(conv && conv.messages.length > 0) {
                         const lastMsg = conv.messages[conv.messages.length - 1];
                         if (lastMsg.role === 'ai') {
                             const allMsgs = document.querySelectorAll('.msg.ai');
                             currentAiMsgElement = allMsgs[allMsgs.length - 1];
                         }
                    }
                }

                if (payload.text === '\n[STREAM COMPLETE]') {
                    if(currentAiMsgElement) {
                        currentAiMsgElement.classList.remove('typing-active');
                        processFilesUpdate(safeBuffer); 
                        addMessageActions(currentAiMsgElement, fullMarkdownBuffer);
                        saveState();
                    }
                    return; 
                }

                const chunk = payload.text || "";
                safeBuffer += chunk; 

                let chatDisplay = safeBuffer;
                const fileTagIndex = safeBuffer.indexOf('<FILE');
                if (fileTagIndex !== -1) {
                    chatDisplay = safeBuffer.substring(0, fileTagIndex);
                }

                const newTextToAdd = chatDisplay.substring(streamCursor);
                if (newTextToAdd.length > 0) {
                     streamCursor += newTextToAdd.length;
                     for (let char of newTextToAdd) typeQueue.push(char);
                     if (!typeInterval) startTyping();
                }
                processFilesUpdate(safeBuffer);

            } catch (err) { console.error("Stream Error:", err); }
        };
    }

    // تهيئة أولية
    renderConversations(); 
    renderTabs();
    renderMessages();
    setTimeout(updateCodeHighlight, 100);
});
</script>

</body>
</html>