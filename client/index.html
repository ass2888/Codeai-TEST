<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<link rel="manifest" href="/manifest.json" />
<title>Codeai</title>
<style>
/* قاعدة عامة لجميع العناصر */
*, *::before, *::after {
    box-sizing: border-box;
}
:root {
  --bg-primary: #080808;      
  --bg-header: #141414;       
  --bg-secondary: #2A2A2A;    
  --text-color: #FFFFFF;      
  --accent-color: #333333;
  --border-color: rgba(255,255,255,0.1);
  --msg-ai-bg: transparent; 
}
[data-theme="light"] {
  --bg-primary: #FFFFFF;
  --bg-header: #F0F0F0;
  --bg-secondary: #E0E0E0;
  --text-color: #080808;
  --accent-color: #CCCCCC;
  --msg-ai-bg: transparent;
  --border-color: rgba(0,0,0,0.1);
}
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* يمنع أي سكرول للصفحة نفسها */
    position: fixed; /* تثبيت الصفحة في مكانها */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-primary);
    color: var(--text-color);
    transition: background 0.3s, color 0.3s;
    /* تحسينات للموبايل */
    -webkit-text-size-adjust: 100%;
    touch-action: none; /* يمنع حركات اللمس الافتراضية للجسم */
}
.topbar { height:70px; display:flex; align-items:center; justify-content:center; padding:8px 12px; background:var(--bg-header); border-bottom:1px solid var(--border-color); position:relative; z-index:100; }
.logo-container { display:flex; align-items:center; font-weight:bold; font-size:18px; opacity:0; transition: opacity 0.3s; }
.logo-symbol { font-family:'Courier New', Courier, monospace; font-size:28px; font-weight:900; margin-right:1px; margin-top:-4px; line-height:1; }/* تعديل الزر ليكون حاوية ثابتة */
.menu-btn { 
    position:fixed; top:12px; left:12px; width:44px; height:44px; 
    border-radius:10px; border:none; background:var(--bg-secondary); 
    color:var(--text-color); font-size:20px; cursor:pointer; z-index:3200; 
    display:flex; align-items:center; justify-content:center; 
    box-shadow:0 2px 5px rgba(0,0,0,0.2); 
    transition: background 0.3s; /* أزلنا تدوير الزر نفسه */
}
/* تنسيق الأيقونة الداخلية لتدور هي فقط */
.menu-btn span {
    display: block;
    transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
}
.menu-btn.active { background: var(--accent-color); }
.menu-btn.active span { transform: rotate(-180deg); } /* التدوير للأيقونة فقط */

/* دعم اللغة العربية (RTL) */[lang="ar"] .msg,
[lang="ar"] .input,
[lang="ar"] .codearea, 
[lang="ar"] .code-highlight {
    direction: rtl;
    text-align: right;
}

/*التأكد من أن الكود الإنجليزي داخل المحادثة يظهر من اليسار لليمين حتى في الوضع العربي */
[lang="ar"] .msg pre,
[lang="ar"] .msg code {
    direction: ltr;
    text-align: left;
}


.root {
    position: fixed;
    left: 0;
    top: 56px;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    z-index: 60;
    pointer-events: none;
    width: 100vw; /* عرض الشاشة فقط */
    max-width: 100%;
    overflow-x: hidden; /* تأكيد إضافي */
}


.input-bar { width:100%; padding:15px 16px 25px 16px; background: linear-gradient(to top, var(--bg-primary) 20%, rgba(0,0,0,0)); backdrop-filter: blur(5px); z-index:100; box-sizing:border-box; display:flex; justify-content:center; pointer-events:auto; }
.input-wrapper { position:relative; width:100%; max-width:800px; }
.input { width:100%; border-radius:30px; padding:16px 60px 16px 20px; border:1px solid var(--border-color); background:var(--bg-secondary); color:var(--text-color); font-size:16px; font-family:inherit; resize:none; overflow-y:hidden; line-height:24px; max-height:150px; box-sizing:border-box; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
.input:focus { outline:none; border-color:#666; }
.send-btn { position:absolute; right:6px; top:6px; width:46px; height:46px; border-radius:50%; border:none; background:var(--text-color); color:var(--bg-primary); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:transform 0.2s; z-index:101; }
.send-btn:active { transform:scale(0.95); }
#welcomeScreen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-primary); z-index:50; transition:opacity 0.3s; pointer-events:none; }
#welcomeScreen > * { pointer-events:auto; }
.welcome-logo { font-size:50px; font-weight:bold; display:flex; align-items:center; margin-bottom:10px; }
.welcome-logo span { font-family:'Courier New', monospace; font-size:70px; font-weight:900; margin-right:5px; }
.welcome-sub { font-size:16px; opacity:0.6; font-weight:normal; }
.hidden { opacity:0; pointer-events:none !important; }
.messages {
    flex: 1;
    overflow-y: auto; /* سكرول عمودي فقط */
    overflow-x: hidden; /* ممنوع السكرول الأفقي */
    padding: 20px 20px 0 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    pointer-events: auto;
    width: 100%;
}
.msg { max-width:90%; padding:12px 16px; border-radius:18px; word-wrap:break-word; line-height:1.6; font-size:15px; color:var(--text-color); }
.msg.user { margin-right:auto; margin-left:0; background:var(--bg-secondary); border-bottom-left-radius:4px; }
.msg.ai { margin-left:auto; margin-right:0; background:transparent; border:none; padding:0 5px; width:100%; max-width:100%; }
@keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }
.typing-cursor { display:inline-block; color:var(--text-color); font-weight:bold; margin-left:2px; animation:blink 1s infinite; }
.msg pre { background:#000; padding:12px; border-radius:8px; overflow-x:auto; margin:10px 0; border:1px solid #333; }
.msg code { font-family:'Consolas', monospace; font-size:13px; color:#e0e0e0; }
.code-snippet-card { background:rgba(255,255,255,0.05); border:1px solid var(--accent-color); border-radius:8px; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; margin:10px 0; cursor:pointer; transition:background 0.2s; }
.code-snippet-card:hover { background:rgba(255,255,255,0.1); }
#menuPanel { position:fixed; left:-320px; top:0; width:300px; height:100%; background:var(--bg-header); padding:80px 12px 40px 12px; box-shadow:2px 0 20px rgba(0,0,0,0.5); transition:transform .3s cubic-bezier(0.25,1,0.5,1); z-index:3000; border-right:1px solid var(--border-color); display:flex; flex-direction:column; box-sizing:border-box; }
#menuPanel.open { transform:translateX(320px); }
#convList { flex:1; overflow-y:auto; margin-bottom:10px; }
#newChatBtn { background:var(--bg-secondary); border:none; color:var(--text-color); font-weight:bold; padding:12px; cursor:pointer; margin-bottom:20px; width:100%; border-radius:8px; }
#openSettings { margin-top:auto; padding:14px; border-radius:8px; background:var(--bg-secondary); color:var(--text-color); border:none; width:100%; }
.codezone { position:fixed; left:100%; top:0; width:100%; height:100%; background:var(--bg-primary); transition:transform .32s ease; z-index:3500; display:flex; flex-direction:column; }
.codezone.open { transform:translateX(-100%); }
.codearea { flex:1; padding:15px; border:none; background:#050505; color:#e6eef8; font-family:'Consolas','Monaco',monospace; font-size:14px; line-height:1.6; resize:none; }
.codearea:focus { outline:none; }
.settings-page { position:fixed; left:0; top:0; right:0; bottom:0; background:var(--bg-primary); padding:20px; display:none; flex-direction:column; z-index:4000; }
.settings-page.open { display:flex; }
.setting-row-btn { width:100%; padding:18px; margin-bottom:10px; background:var(--bg-secondary); border-radius:12px; color:var(--text-color); border:none; text-align:left; cursor:pointer; }
.popover-options { position:absolute; top:70px; left:20px; background:var(--bg-header); border:1px solid var(--border-color); padding:8px; border-radius:12px; display:none; flex-direction:column; z-index:4010; min-width:160px; }
.popover-options.show { display:flex; }
.option-item { padding:10px; cursor:pointer; }
.fullscreen-overlay { background:#fff; z-index:5000; display:none; flex-direction:column; position:fixed; top:0; left:0; right:0; bottom:0; width:100%; height:100%; }
.fullscreen-overlay.active { display:flex; }
.preview-header { height:56px; background:#f0f0f0; display:flex; align-items:center; justify-content:space-between; padding:0 16px; color:#000; border-bottom:1px solid #ccc; }
.run-fab { position:absolute; bottom:24px; right:24px; width:60px; height:60px; border-radius:16px; background:var(--bg-secondary); border:1px solid var(--border-color); box-shadow:0 6px 20px rgba(0,0,0,0.6); cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10; }
.play-icon { width:0; height:0; border-left:18px solid var(--text-color); border-top:10px solid transparent; border-bottom:10px solid transparent; margin-left:4px; }
/* New class for settings/close buttons */
.settings-btn { background:var(--bg-secondary); border:1px solid var(--border-color); color:var(--text-color); border-radius:20px; font-weight:bold; cursor:pointer; }
/* حاوية محرر الكود */
.editor-container {
    position: relative;
    flex: 1;
    width: 100%;
    height: 100%;
    background: #050505;
    overflow: hidden;
}
/* التنسيق المشترك للمحرر وطبقة التلوين ليظهروا متطابقين تماماً */
.codearea, .code-highlight {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 15px;
    margin: 0;
    border: none;
    font-family: 'Consolas', 'Monaco', monospace; /* نوع خط موحد */
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    box-sizing: border-box;
    text-align: left; /* الكود دائما يسار لليمين */
    direction: ltr;
}
/* منطقة الكتابة الفعلية (شفافة) */
.codearea {
    z-index: 2;
    background: transparent;
    color: transparent; /* النص شفاف لنرى الألوان تحته */
    caret-color: #fff; /* لون مؤشر الكتابة */
    resize: none;
}
.codearea:focus { outline: none; }

/* طبقة الألوان (في الخلفية) */
.code-highlight {
    z-index: 1;
    pointer-events: none; /* لا تتفاعل مع الماوس */
    background: #050505;
    color: #e6eef8;
    overflow: hidden; 
}
/* تنسيق القيم في الإعدادات */
.setting-value {
    float: right;
    font-weight: 900; /* سميك جداً */
    opacity: 0.9;
}
html[dir="rtl"] .setting-value { float: left; }

/* تعديل زر الإرسال الجديد */
.send-icon-new {
    width: 24px;
    height: 24px;
    fill: var(--bg-primary);
    transform: rotate(-90deg); /* تدوير أيقونة السهم لليسار لتشير للأعلى */
    font-weight: bold;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
</head>
<body>
<button id="menuBtn" class="menu-btn" aria-label="menu"><span>☰</span></button>
  <div id="welcomeScreen">
      <div class="welcome-logo">
          <span>&lt;</span>odeai
      </div>
      <div class="welcome-sub">What can I help you with?</div>
  </div>
  <div class="topbar">
    <div id="topLogo" class="logo-container">
        <span class="logo-symbol">&lt;</span>
        <span class="logo-text-part">odeai</span>
    </div>
  </div>
  <div id="menuPanel">
    <button id="newChatBtn">New chat +</button>
    <h3 style="margin:10px 0 5px 0; color:var(--text-color); opacity:0.6; font-size:12px; text-transform:uppercase">Conversations</h3>
    <div id="convList"></div>
    <button id="openSettings">Settings</button>
  </div>

  <div class="root">
    <div id="messages" class="messages" aria-live="polite"></div>
    <div class="input-bar">
      <div class="input-wrapper">
         <textarea id="input" class="input" placeholder="Type a message..." rows="1"></textarea>
        <button id="sendBtn" class="send-btn" title="Send">
    <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
</button>
      </div>
    </div>
  </div>
<div id="codezone" class="codezone" aria-hidden="true">
    <div style="height:56px;display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--bg-header);border-bottom:1px solid var(--border-color)">
      <div style="font-weight:bold">Project Code</div>
      <button id="closeCodeBtn" class="settings-btn" style="font-size:14px; width:auto; padding:6px 15px;">Back</button>
    </div>
    
    <div class="editor-container">
        <pre class="code-highlight" aria-hidden="true"><code id="highlighting-content" class="language-javascript"></code></pre>
        <textarea id="codeArea" class="codearea" spellcheck="false">// Your project code will appear here...</textarea>
    </div>

    <button id="runFab" class="run-fab" title="Run Code">
      <div class="play-icon"></div>
    </button>
  </div>


  <div id="previewOverlay" class="fullscreen-overlay">
    <div class="preview-header">
      <span>Live Preview</span>
      <button id="closePreviewMain" class="settings-btn" style="background:#ddd; color:#000; font-size:14px;width:auto;padding:6px 15px;">Close</button>
    </div>
    <iframe id="previewFrame" style="flex:1;border:none;background:#fff"></iframe>
  </div>
<div id="settingsPage" class="settings-page" aria-hidden="true">
    <h2 style="margin-bottom:30px; margin-top:40px">Settings</h2>
    
    <div style="position:relative;">
        <button id="themeBtn" class="setting-row-btn">
            Theme <span id="themeValue" class="setting-value">Dark</span>
        </button>
        <div id="themePopover" class="popover-options">
            <div class="option-item" onclick="setTheme('dark')">Dark</div>
            <div class="option-item" onclick="setTheme('light')">Light</div>
        </div>
    </div>

    <div style="position:relative;">
        <button id="langBtn" class="setting-row-btn">
            Language <span id="langValue" class="setting-value">English</span>
        </button>
        <div id="langPopover" class="popover-options">
            <div class="option-item" onclick="setLanguage('en')">English</div>
            <div class="option-item" onclick="setLanguage('ar')">العربية</div>
        </div>
    </div>

    <div style="margin-top:auto; display:flex; justify-content:center; margin-bottom: 20px;">
      <button id="closeSettings" style="padding:14px 40px; border-radius:30px; background:transparent; border:1px solid var(--border-color); color:var(--text-color); cursor:pointer">Close</button>
    </div>
  </div>
  

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Constants & Setup ---
    const RENDER_SERVER_URL = ''; 
    let convs = [];
    try {
        convs = JSON.parse(localStorage.getItem('codeai_convs') || '[]');
    } catch(e) { console.error("Storage corrupted", e); convs=[]; }
    
    let activeId = null;
    let isStreaming = false;
    let safeBuffer = "";
    let typeQueue = []; 
    let typeInterval = null; 
    let currentAiMsgElement = null; 
    let fullMarkdownBuffer = ""; 
    let streamCursor = 0;

    // --- Elements ---
    const messagesEl = document.getElementById('messages');
    const codeArea = document.getElementById('codeArea');
    const highlightingContent = document.getElementById('highlighting-content'); // عنصر التلوين
    const inputEl = document.getElementById('input');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const topLogo = document.getElementById('topLogo');
    const menuBtn = document.getElementById('menuBtn');
    const menuPanel = document.getElementById('menuPanel');
    const codezone = document.getElementById('codezone');
    const settingsPage = document.getElementById('settingsPage');

    // --- Settings Logic ---
    function updateSettingsUI() {
        const t = localStorage.getItem('codeai_theme') || 'dark';
        const l = localStorage.getItem('codeai_lang') || 'en';
        
        document.getElementById('themeValue').textContent = t.charAt(0).toUpperCase() + t.slice(1);
        document.getElementById('langValue').textContent = l === 'en' ? 'English' : 'العربية';
        
        // الثيم
        document.documentElement.setAttribute('data-theme', t);
        
        // اللغة: نضع الخاصية lang فقط، ولا نغير dir لكي لا تنقلب الصفحة
        document.documentElement.setAttribute('lang', l);
    }

    // تهيئة الإعدادات عند البدء
    updateSettingsUI();

    window.setTheme = function(mode) {
        localStorage.setItem('codeai_theme', mode);
        document.getElementById('themePopover').classList.remove('show');
        updateSettingsUI();
    };

    window.setLanguage = function(lang) {
        localStorage.setItem('codeai_lang', lang);
        document.getElementById('langPopover').classList.remove('show');
        updateSettingsUI();
        // تحديث الرسائل لتطبيق التنسيق الجديد
        renderMessages();
    };

    // --- Code Highlighting Logic (FIXED) ---
    // تم نقلها هنا لضمان عملها، وتم استدعاؤها فوراً
    function updateCodeHighlight() {
        let text = codeArea.value || '';
        if(text.length > 0 && text[text.length-1] === "\n") { 
            text += " "; 
        }
        highlightingContent.textContent = text;
        if(window.Prism) {
            Prism.highlightElement(highlightingContent);
        }
    }

    // تفعيل المستمعين للكود
    codeArea.addEventListener('input', updateCodeHighlight);
    codeArea.addEventListener('scroll', function() {
        highlightingContent.parentElement.scrollTop = this.scrollTop;
        highlightingContent.parentElement.scrollLeft = this.scrollLeft;
    });
    
    // استدعاء أولي لضمان ظهور الكود عند فتح الصفحة
    updateCodeHighlight();

    // --- Markdown Setup ---
    if (typeof marked !== 'undefined') {
        marked.setOptions({ gfm: true, breaks: true });
    }

    // --- Event Listeners (UI) ---
    menuBtn.addEventListener('click', () => {
        menuPanel.classList.toggle('open');
        menuBtn.classList.toggle('active');
    });

    document.getElementById('newChatBtn').addEventListener('click', () => {
        activeId = null;
        codeArea.value = '// start';
        updateCodeHighlight(); // تحديث الألوان
        renderMessages();
        menuPanel.classList.remove('open');
        menuBtn.classList.remove('active');
    });

    document.getElementById('openSettings').addEventListener('click', () => {
        settingsPage.classList.add('open');
        menuPanel.classList.remove('open');
        menuBtn.classList.remove('active');
    });

    document.getElementById('closeSettings').addEventListener('click', () => {
        settingsPage.classList.remove('open');
    });

    document.getElementById('themeBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('themePopover').classList.toggle('show');
        document.getElementById('langPopover').classList.remove('show');
    });
    
    document.getElementById('langBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('langPopover').classList.toggle('show');
        document.getElementById('themePopover').classList.remove('show');
    });

    document.addEventListener('click', () => {
        document.getElementById('themePopover').classList.remove('show');
        document.getElementById('langPopover').classList.remove('show');
    });

    // Swipe Codezone
    let startX = 0;
    document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});
    document.addEventListener('touchend', e => {
        const endX = (e.changedTouches[0] && e.changedTouches[0].clientX) || startX;
        if (endX - startX < -80) { 
            codezone.classList.add('open'); 
            updateCodeHighlight(); // تحديث عند الفتح بالسحب
        }
        if (endX - startX > 80) codezone.classList.remove('open');
    }, {passive: true});

    document.getElementById('closeCodeBtn').addEventListener('click', () => {
        codezone.classList.remove('open');
    });
    
    // Preview
    const runFab = document.getElementById('runFab');
    const previewOverlay = document.getElementById('previewOverlay');
    runFab.addEventListener('click', () => {
        previewOverlay.classList.add('active');
        document.getElementById('previewFrame').srcdoc = codeArea.value;
    });
    document.getElementById('closePreviewMain').addEventListener('click', () => {
        previewOverlay.classList.remove('active');
    });

    // Input Logic
    inputEl.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        this.style.overflowY = this.scrollHeight > 150 ? 'auto' : 'hidden';
    });
    inputEl.addEventListener('keydown', e => { 
        if(e.key==='Enter' && !e.shiftKey){ 
            e.preventDefault(); 
            document.getElementById('sendBtn').click(); 
        }
    });

    document.getElementById('sendBtn').addEventListener('click', ()=> {
        const v = inputEl.value.trim();
        if(!v) return;
        inputEl.value=''; 
        inputEl.style.height = 'auto';
        sendMessage(v);
    });

    // --- Core Functions ---
    function renderMessages(){
        messagesEl.innerHTML = '';
        if(!activeId) {
            welcomeScreen.classList.remove('hidden');
            topLogo.style.opacity = '0';
            return;
        }

        const conv = convs.find(c=>c.id===activeId);
        if(!conv || conv.messages.length === 0) {
            welcomeScreen.classList.remove('hidden');
            topLogo.style.opacity = '0';
        } else {
            welcomeScreen.classList.add('hidden');
            topLogo.style.opacity = '1';
        }

        if(conv) {
            conv.messages.forEach((m, index) => {
                const d = document.createElement('div');
                d.className = 'msg ' + (m.role==='user'?'user':'ai');
                let htmlContent = typeof marked !== 'undefined' ? marked.parse(m.text || '') : m.text;
                
                if (m.role === 'ai' && isStreaming && index === conv.messages.length - 1) {
                    d.innerHTML = htmlContent + '<span class="typing-cursor">|</span>';
                } else {
                    d.innerHTML = htmlContent;
                }
                messagesEl.appendChild(d);
            });
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function saveState(){ localStorage.setItem('codeai_convs', JSON.stringify(convs)); }

    async function sendMessage(text){
        if(!text) return;
        welcomeScreen.classList.add('hidden');
        topLogo.style.opacity = '1';

        if (!activeId) {
            const newId = Date.now().toString();
            const title = text.length > 30 ? text.substring(0, 30) + '...' : text;
            convs.unshift({ id: newId, title: title, messages: [], code: '// Start coding...' });
            activeId = newId;
            renderConversations();
        }

        const conv = convs.find(c=>c.id===activeId);
        conv.messages.push({role:'user', text});
        saveState();
        renderMessages();

        isStreaming = true;
        safeBuffer = ""; 
        fullMarkdownBuffer = ""; 
        typeQueue = []; 
        streamCursor = 0;
        currentAiMsgElement = null;

        conv.messages.push({role:'ai', text:''}); 
        saveState();
        renderMessages();

        try{
            await fetch(RENDER_SERVER_URL + '/api/chat', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({message:text, convId:activeId, code:conv.code||''})
            });
        } catch(err){
            const last = conv.messages[conv.messages.length-1];
            last.text = 'Error: Could not reach server.';
            isStreaming = false;
            saveState(); 
            renderMessages();
        }
    }

    function renderConversations(){
        const c = document.getElementById('convList');
        c.innerHTML = '';
        convs.forEach(cv=>{
            const el = document.createElement('div'); 
            el.style.padding='14px'; 
            el.style.borderBottom='1px solid var(--border-color)';
            el.style.cursor='pointer'; 
            el.style.color = 'var(--text-color)';
            el.textContent=cv.title;
            el.addEventListener('click', ()=> { 
                activeId = cv.id; 
                codeArea.value = cv.code || ''; 
                updateCodeHighlight(); // تحديث الألوان عند تحميل المحادثة
                renderMessages(); 
                menuPanel.classList.remove('open'); 
                menuBtn.classList.remove('active');
            });
            c.appendChild(el);
        });
    }

    function startTyping() {
        typeInterval = setInterval(() => {
            if (typeQueue.length > 0) {
                const char = typeQueue.shift();
                fullMarkdownBuffer += char; 
                if (currentAiMsgElement) {
                    let html = marked.parse(fullMarkdownBuffer);
                    currentAiMsgElement.innerHTML = html + '<span class="typing-cursor">&lt;</span>';
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
                const conv = convs.find(c => c.id === activeId);
                if(conv) {
                    const lastMsg = conv.messages[conv.messages.length - 1];
                    lastMsg.text = fullMarkdownBuffer;
                }
            } else {
                clearInterval(typeInterval);
                typeInterval = null;
            }
        }, 30); 
    }

    if(typeof(EventSource) !== 'undefined'){
        const sse = new EventSource(RENDER_SERVER_URL + '/api/events');
        const TAG_START = "<CODE_UPDATE>";
        const TAG_END = "</CODE_UPDATE>";

        sse.onmessage = (e) => {
            try {
                if (e.data === ': keep-alive\n\n') return;
                const payload = JSON.parse(e.data);
                if(payload.type !== 'assistant_message') return;

                if (!currentAiMsgElement && isStreaming) {
                    const conv = convs.find(c => c.id === activeId);
                    if(conv && conv.messages.length > 0) {
                         const lastMsg = conv.messages[conv.messages.length - 1];
                         if (lastMsg.role === 'ai') {
                             const allMsgs = document.querySelectorAll('.msg.ai');
                             currentAiMsgElement = allMsgs[allMsgs.length - 1];
                         }
                    }
                }

                if (payload.text === '\n[STREAM COMPLETE]') return; 

                const chunk = payload.text || "";
                safeBuffer += chunk; 

                let chatContent = safeBuffer;
                let projectCode = null;
                const startIndex = safeBuffer.indexOf(TAG_START);

                if (startIndex !== -1) {
                    chatContent = safeBuffer.substring(0, startIndex);
                    const remaining = safeBuffer.substring(startIndex + TAG_START.length);
                    const endIndex = remaining.indexOf(TAG_END);
                    if (endIndex !== -1) {
                        projectCode = remaining.substring(0, endIndex).trim();
                    } else {
                        projectCode = remaining.trim();
                    }
                }
                
                const newTextToAdd = chatContent.substring(streamCursor);
                if (newTextToAdd.length > 0) {
                     streamCursor += newTextToAdd.length;
                     for (let char of newTextToAdd) typeQueue.push(char);
                     if (!typeInterval) startTyping();
                }

                if (projectCode && projectCode.length > 0) {
                    let cleanCode = projectCode.trim().replace(/^```[a-z]*\n?/i, '').replace(/```$/i, '');
                    codeArea.value = cleanCode;
                    updateCodeHighlight(); // تلوين الكود الجديد فوراً
                    const conv = convs.find(c => c.id === activeId);
                    if(conv) conv.code = cleanCode;
                }
            } catch (err) { console.error("Stream Error:", err); }
        };
    }

    // تهيئة أولية
    renderConversations(); 
    renderMessages();
    // تفعيل التلوين للكود المبدئي
    setTimeout(updateCodeHighlight, 100);
});
</script>

</body>
</html>